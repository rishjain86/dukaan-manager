<!doctype html>

<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dukaan Manager ‚Äî Cleaned</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{padding:12px;background:#f8f9fa}
    .thumb-img{width:40px;height:40px;object-fit:cover;border-radius:6px}
    .status-small{margin-top:8px}
    table th,table td{text-align:center;vertical-align:middle}
  </style>
</head>
<body>
  <nav class="navbar bg-primary text-white mb-3">
    <div class="container-fluid">
      <span class="navbar-brand text-white">üì¶ Dukaan Manager</span>
      <button class="btn btn-light btn-sm" onclick="logout()">Logout</button>
    </div>
  </nav>  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>üì¶ ‡§á‡§®‡•ç‡§µ‡•á‡§Ç‡§ü‡§∞‡•Ä</h4>
      <button class="btn btn-success" onclick="openModal()">+ ‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
    </div><div class="table-responsive">
  <table class="table table-bordered table-hover">
    <thead class="table-light">
      <tr>
        <th>‡§´‡•ã‡§ü‡•ã</th>
        <th>‡§®‡§æ‡§Æ</th>
        <th>‡§è‡§Æ‡§Ü‡§∞‡§™‡•Ä (‚Çπ)</th>
        <th>‡§°‡§ø‡§∏‡•ç‡§ï‡§æ‡§â‡§Ç‡§ü (%)</th>
        <th>‡§ë‡§´‡§∞ ‡§™‡•ç‡§∞‡§æ‡§á‡§∏ (‚Çπ)</th>
        <th>‡§∏‡•ç‡§ü‡•â‡§ï</th>
        <th>‡§á‡§ï‡§æ‡§à</th>
        <th>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</th>
        <th>‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à</th>
      </tr>
    </thead>
    <tbody id="inventory-table"></tbody>
  </table>
</div>

<div id="status" class="small text-muted status-small"></div>

  </div>  <!-- Add/Edit modal -->  <div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="modal-title" class="modal-title">‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="item-id"><div class="mb-2">
        <label class="form-label">‡§®‡§æ‡§Æ</label>
        <input id="item-name" class="form-control" required>
      </div>

      <div class="row">
        <div class="col-md-4 mb-2">
          <label class="form-label">‡§ï‡•Ä‡§Æ‡§§ (‚Çπ)</label>
          <input id="item-price" type="number" class="form-control">
        </div>
        <div class="col-md-4 mb-2">
          <label class="form-label">‡§°‡§ø‡§∏‡•ç‡§ï‡§æ‡§â‡§Ç‡§ü (%)</label>
          <input id="item-discount" type="number" class="form-control">
        </div>
        <div class="col-md-4 mb-2">
          <label class="form-label">‡§ë‡§´‡§∞ ‡§™‡•ç‡§∞‡§æ‡§á‡§∏ (‚Çπ)</label>
          <input id="item-offerprice" type="number" class="form-control">
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-2">
          <label class="form-label">‡§∏‡•ç‡§ü‡•â‡§ï</label>
          <input id="item-stock" type="number" class="form-control">
        </div>
        <div class="col-md-4 mb-2">
          <label class="form-label">‡§á‡§ï‡§æ‡§à</label>
          <input id="item-unit" class="form-control" placeholder="kg / pack / litre">
        </div>
        <div class="col-md-4 mb-2">
          <label class="form-label">‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</label>
          <input id="item-category" class="form-control" placeholder="Dairy, Snacks...">
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">‡§´‡•ã‡§ü‡•ã (‡§Ö‡§ó‡§∞ ‡§∞‡§ñ‡§®‡§æ ‡§π‡•ã)</label>
        <input id="item-photo" type="file" accept="image/*" class="form-control">
        <div class="form-text">Image will be uploaded to Cloudinary. Replace Cloudinary details below with your own.</div>
      </div>

      <small class="text-muted">‡§∏‡•ç‡§Æ‡§∞‡§£: ‡§´‡•ã‡§ü‡•ã optional ‡§π‡•à ‚Äî ‡§Ö‡§ó‡§∞ ‡§Ü‡§™ Cloudinary ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§§‡•ã ‡§ñ‡§æ‡§≤‡•Ä ‡§õ‡•ã‡•ú‡•á‡§Ç‡•§</small>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">‡§∞‡§¶‡•ç‡§¶</button>
      <button class="btn btn-primary" onclick="saveItem()">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
    </div>
  </div>
</div>

  </div>  <!-- Firebase and app script -->  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>  <script>
  // ====== CONFIG ======
  const firebaseConfig = {
    apiKey: "AIzaSyAomDsqeLOrXvnudqUsudnZWOphuqM0bvY",
    authDomain: "shopkeeper-99756.firebaseapp.com",
    projectId: "shopkeeper-99756",
    storageBucket: "shopkeeper-99756.firebasestorage.app",
    messagingSenderId: "786338847396",
    appId: "1:786338847396:web:c6e042952145780f8aa431",
    measurementId: "G-PCE1MM86YE"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ====== CLOUDINARY (Client-side unsigned) ======
  // Create an unsigned upload preset in Cloudinary and set below
  const CLOUDINARY_CLOUD = 'your_cloud_name';
  const CLOUDINARY_UPLOAD_PRESET = 'your_upload_preset';
  const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/upload`;

  // ====== Global state ======
  let shopId = null; // set after auth/shop resolve
  let inventoryUnsub = null;

  function setStatus(msg, type='secondary'){
    const s = document.getElementById('status');
    s.textContent = msg || '';
    s.className = `small text-${type}`;
  }

  // Helper: icon or default image
  function getThumb(src){
    if(!src) return 'https://via.placeholder.com/40?text=?';
    return src;
  }

  // ====== Inventory listener (live) ======
  function startInventoryListener(){
    if(!shopId) { setStatus('No shopId set.','danger'); return; }
    if(inventoryUnsub) inventoryUnsub();
    setStatus('Loading inventory...','secondary');

    inventoryUnsub = db.collection('shops').doc(shopId).collection('items').orderBy('name')
      .onSnapshot(snapshot => {
        let html = '';
        snapshot.forEach(doc => {
          const item = doc.data();
          const photo = getThumb(item.imageUrl);
          const offer = (typeof item.offerPrice !== 'undefined' && item.offerPrice !== null) ? item.offerPrice : item.price;
          const discount = item.discountPercent || 0;

          html += `\n<tr>`+
                  `<td><img src="${photo}" class="thumb-img" alt="photo"></td>`+
                  `<td>${item.name || ''}</td>`+
                  `<td>‚Çπ${item.price ?? ''}</td>`+
                  `<td>${discount}%</td>`+
                  `<td>‚Çπ${offer}</td>`+
                  `<td>${item.stock ?? ''}</td>`+
                  `<td>${item.unit || ''}</td>`+
                  `<td>${item.category || ''}</td>`+
                  `<td>`+
                    `<button class="btn btn-sm btn-warning me-1" onclick="editItem('${doc.id}')">‚úèÔ∏è</button>`+
                    `<button class="btn btn-sm btn-danger" onclick="deleteItem('${doc.id}')">üóëÔ∏è</button>`+
                  `</td>`+
                `</tr>`;
        });
        document.getElementById('inventory-table').innerHTML = html;
        setStatus(`Inventory loaded (${snapshot.size} items).`, 'success');
      }, err => {
        console.error('Inventory listener error:', err);
        setStatus('Error loading inventory: ' + err.message, 'danger');
      });
  }

  // ====== Open modal for new item ======
  function openModal(){
    document.getElementById('modal-title').textContent = '‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ';
    ['item-id','item-name','item-price','item-stock','item-unit','item-category','item-discount','item-offerprice'].forEach(id=>{
      const el = document.getElementById(id); if(el) el.value = '';
    });
    document.getElementById('item-photo').value = '';
    new bootstrap.Modal(document.getElementById('itemModal')).show();
  }

  // ====== Edit existing item ======
  async function editItem(id){
    if(!shopId) return;
    try{
      const doc = await db.collection('shops').doc(shopId).collection('items').doc(id).get();
      if(!doc.exists) return;
      const i = doc.data();
      document.getElementById('modal-title').textContent = '‡§Ü‡§á‡§ü‡§Æ ‡§∏‡§Ç‡§™‡§æ‡§¶‡§®';
      document.getElementById('item-id').value = id;
      document.getElementById('item-name').value = i.name || '';
      document.getElementById('item-price').value = i.price ?? '';
      document.getElementById('item-stock').value = i.stock ?? '';
      document.getElementById('item-unit').value = i.unit || '';
      document.getElementById('item-category').value = i.category || '';
      document.getElementById('item-discount').value = i.discountPercent ?? '';
      document.getElementById('item-offerprice').value = i.offerPrice ?? '';
      document.getElementById('item-photo').value = '';
      new bootstrap.Modal(document.getElementById('itemModal')).show();
    } catch(e){ console.error(e); setStatus('Error loading item: ' + e.message,'danger'); }
  }

  // ====== Upload image to Cloudinary (returns url) ======
  async function uploadToCloudinary(file){
    if(!file) return null;
    if(!CLOUDINARY_CLOUD || !CLOUDINARY_UPLOAD_PRESET) {
      console.warn('Cloudinary details not set ‚Äî skipping image upload.');
      return null;
    }
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    const res = await fetch(CLOUDINARY_URL, { method:'POST', body: fd });
    const data = await res.json();
    return data.secure_url || data.url || null;
  }

  // ====== Save item (create/update) ======
  async function saveItem(){
    if(!shopId) return;
    const id = document.getElementById('item-id').value;
    const name = document.getElementById('item-name').value.trim();
    const price = Number(document.getElementById('item-price').value) || 0;
    const stock = Number(document.getElementById('item-stock').value) || 0;
    const unit = document.getElementById('item-unit').value.trim();
    const category = document.getElementById('item-category').value.trim();
    const discount = Number(document.getElementById('item-discount').value) || 0;
    const offerPriceInput = document.getElementById('item-offerprice').value;
    const offerPrice = (offerPriceInput === '' || offerPriceInput === null) ? null : Number(offerPriceInput);

    if(!name){ alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§≠‡§∞‡•á‡§Ç'); return; }

    const photoFile = document.getElementById('item-photo').files[0];

    setStatus('Saving item...', 'secondary');

    try{
      // upload image first (if present)
      let imageUrl = null;
      if(photoFile) imageUrl = await uploadToCloudinary(photoFile);

      const colRef = db.collection('shops').doc(shopId).collection('items');
      let docRef = id ? colRef.doc(id) : colRef.doc();

      const itemData = {
        name,
        price,
        stock,
        unit,
        category,
        discountPercent: discount,
        offerPrice: (offerPrice !== null && !isNaN(offerPrice)) ? offerPrice : (price || null),
        status: 'active',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      if(imageUrl) itemData.imageUrl = imageUrl;
      if(!id){ // set createdAt if new
        await docRef.set(Object.assign({}, itemData, { createdAt: firebase.firestore.FieldValue.serverTimestamp() }));
      } else {
        await docRef.update(itemData);
      }

      setStatus('Item saved.', 'success');
      bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
      // No explicit reload needed ‚Äî onSnapshot will update the table automatically

    } catch(err){
      console.error(err);
      setStatus('Error saving item: ' + err.message, 'danger');
    }
  }

  // ====== Delete ======
  function deleteItem(id){
    if(!shopId) return;
    if(!confirm('‡§Ü‡§á‡§ü‡§Æ ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•ã?')) return;
    db.collection('shops').doc(shopId).collection('items').doc(id).delete()
      .then(()=> setStatus('Item deleted.','success'))
      .catch(err=> { console.error(err); setStatus('Error deleting item: '+err.message,'danger'); });
  }

  // ====== Logout ======
  function logout(){ auth.signOut().finally(()=>{ try{ localStorage.removeItem('shopId'); }catch(e){} window.location.href='index.html'; }); }

  // ====== AUTH + resolve shop ======
  auth.onAuthStateChanged(async user => {
    if(!user){ alert('Session expired. Please login again.'); window.location.href='index.html'; return; }
    try{
      // try localStorage first
      shopId = localStorage.getItem('shopId');
    } catch(e){ console.warn('Cannot read shopId:', e); }

    try{
      if(!shopId){
        const doc = await db.collection('shopUsers').doc(user.uid).get();
        if(doc.exists) shopId = doc.data().shopId;
      }
      if(!shopId){ alert('No shop linked with this user. Please register again.'); window.location.href='index.html'; return; }
      setStatus('Shop ID: ' + shopId, 'secondary');
      startInventoryListener();
    } catch(e){ console.error(e); setStatus('Error resolving shop: '+ e.message,'danger'); }
  });

  </script>  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script></body>
</html>
