<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dukaan Manager ‚Äî Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body { background: #f5f6fa; padding: 12px; }
    table th, table td { text-align:center; vertical-align:middle; }
    .thumb-img { width:55px; height:55px; object-fit:cover; border-radius:6px; }
    #photo-preview { width:110px; height:110px; object-fit:cover; border-radius:8px; border:1px solid #ccc; display:none; margin-bottom:10px; }
    .low-stock { background:#fff6f6; }
    .stat-box { padding:12px; border-radius:10px; font-weight:600; color:white; text-align:center; }
    .small-muted { color:#6c757d; }
    .modal-lg { max-width:1000px; }
    .nowrap { white-space:nowrap; }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary mb-3">
  <div class="container-fluid">
    <span class="navbar-brand">üì¶ Dukaan Manager</span>
    <div class="d-flex gap-2">
      <button id="btn-backup" class="btn btn-light btn-sm d-none d-md-inline">Backup</button>
      <button onclick="logout()" class="btn btn-light btn-sm">Logout</button>
    </div>
  </div>
</nav>

<div class="container mb-4">
  <div class="row g-3">
    <div class="col-6 col-md-3"><div class="stat-box bg-success"><div id="stat-items">0</div><small class="d-block">‡§ï‡•Å‡§≤ ‡§Ü‡§á‡§ü‡§Æ</small></div></div>
    <div class="col-6 col-md-3"><div class="stat-box bg-danger"><div id="stat-low">0</div><small class="d-block">Low Stock</small></div></div>
    <div class="col-6 col-md-3"><div class="stat-box bg-warning text-dark"><div id="stat-cat">0</div><small class="d-block">‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Å</small></div></div>
    <div class="col-6 col-md-3"><div class="stat-box bg-info"><div id="stat-active">0</div><small class="d-block">Active Items</small></div></div>
  </div>
</div>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="mb-0">üì¶ Inventory</h4>
    <div>
      <button class="btn btn-outline-primary me-2" id="btn-open-orders">‡§ë‡§∞‡•ç‡§°‡§∞ ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
      <button class="btn btn-success" onclick="openModal()">+ ‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>‡§´‡•ã‡§ü‡•ã</th>
          <th>‡§®‡§æ‡§Æ</th>
          <th>‡§è‡§Æ‡§Ü‡§∞‡§™‡•Ä</th>
          <th>‡§°‡§ø‡§∏‡•ç‡§ï‡§æ‡§â‡§Ç‡§ü</th>
          <th>‡§ë‡§´‡§∞ ‡§™‡•ç‡§∞‡§æ‡§á‡§∏</th>
          <th>‡§∏‡•ç‡§ü‡•â‡§ï</th>
          <th>‡§á‡§ï‡§æ‡§à</th>
          <th>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</th>
          <th>‡§ï‡§æ‡§∞‡•ç‡§Ø</th>
        </tr>
      </thead>
      <tbody id="inventory-table"></tbody>
    </table>
  </div>

  <div id="status" class="small text-muted mt-2"></div>
</div>

<!-- ORDERS MODAL -->
<div class="modal fade" id="ordersModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">‡§≤‡§æ‡§á‡§µ ‡§ë‡§∞‡•ç‡§°‡§∞</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="orders-status" class="small text-muted mb-2"></div>
        <div class="table-responsive">
          <table class="table table-hover table-bordered">
            <thead class="table-light">
              <tr><th>Order ID</th><th>Customer</th><th>Items</th><th>Amount</th><th>Payment</th><th>Status</th><th>Time</th><th>Action</th></tr>
            </thead>
            <tbody id="orders-table"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div>
  </div>
</div>

<!-- ORDER DETAIL MODAL -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Order Details</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="order-detail-content"></div>
        <div class="mt-3">
          <label class="form-label">Transaction ID / UTR</label>
          <input id="order-utr" class="form-control mb-2" />
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-success" id="btn-accept">Accept</button>
            <button class="btn btn-sm btn-warning" id="btn-packed">Packed</button>
            <button class="btn btn-sm btn-info" id="btn-ready">Ready</button>
            <button class="btn btn-sm btn-primary" id="btn-delivered">Delivered</button>
          </div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div>
  </div>
</div>

<!-- ITEM MODAL -->
<div class="modal fade" id="itemModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 id="modal-title" class="modal-title">‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <img id="photo-preview" />
        <input type="hidden" id="item-id" />

        <label class="form-label">‡§®‡§æ‡§Æ</label>
        <input id="item-name" class="form-control mb-2">

        <div class="row mb-2">
          <div class="col-md-4"><label class="form-label">‡§ï‡•Ä‡§Æ‡§§ (‚Çπ)</label><input id="item-price" type="number" class="form-control" /></div>
          <div class="col-md-4"><label class="form-label">‡§°‡§ø‡§∏‡•ç‡§ï‡§æ‡§â‡§Ç‡§ü (%)</label><input id="item-discount" type="number" class="form-control" /></div>
          <div class="col-md-4"><label class="form-label">‡§ë‡§´‡§∞ ‡§™‡•ç‡§∞‡§æ‡§á‡§∏ (‚Çπ)</label><input id="item-offerprice" type="number" class="form-control" /></div>
        </div>

        <div class="row mb-2">
          <div class="col-md-4"><label class="form-label">‡§∏‡•ç‡§ü‡•â‡§ï</label><input id="item-stock" type="number" class="form-control" /></div>
          <div class="col-md-4"><label class="form-label">‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§∏‡•ç‡§ü‡•â‡§ï</label><input id="item-min-stock" type="number" class="form-control" placeholder="5" /></div>
          <div class="col-md-4"><label class="form-label">‡§á‡§ï‡§æ‡§à</label><input id="item-unit" class="form-control" /></div>
        </div>

        <div class="row mb-2">
          <div class="col-md-6"><label class="form-label">‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</label><input id="item-category" class="form-control" /></div>
          <div class="col-md-6"><label class="form-label">‡§µ‡§ø‡§µ‡§∞‡§£</label><input id="item-description" class="form-control" /></div>
        </div>

        <label class="form-label">‡§´‡•ã‡§ü‡•ã</label>
        <input id="item-photo" type="file" accept="image/*" class="form-control" />

        <div class="form-check form-switch mt-2">
          <input class="form-check-input" type="checkbox" id="item-active" checked>
          <label class="form-check-label" for="item-active">‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø</label>
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">‡§∞‡§¶‡•ç‡§¶</button>
        <button class="btn btn-primary" onclick="saveItem()">‡§∏‡•á‡§µ</button>
      </div>

    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
/* ============================
   FIREBASE CONFIG + INIT
============================ */
const firebaseConfig = {
  apiKey: "AIzaSyAomDsqeLOrXvnudqUsudnZWOphuqM0bvY",
  authDomain: "shopkeeper-99756.firebaseapp.com",
  projectId: "shopkeeper-99756",
  storageBucket: "shopkeeper-99756.firebasestorage.app",
  messagingSenderId: "786338847396",
  appId: "1:786338847396:web:c6e042952145780f8aa431",
  measurementId: "G-PCE1MM86YE"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ============================
   CLOUDINARY CONFIG
============================ */
const CLOUDINARY_CLOUD = "darmz4wsz";
const CLOUDINARY_UPLOAD_PRESET = "emotional_preset";
const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/upload`;

/* ============================
   GLOBAL VARS
============================ */
let shopId = "SHOP001";
let inventoryUnsub = null;
let ordersUnsub = null;

/* ============================
   STATUS MESSAGE
============================ */
function setStatus(msg, type="secondary") {
  const s = document.getElementById("status");
  s.textContent = msg;
  s.className = `small text-${type}`;
}

/* ============================
   THUMBNAIL IMAGE
============================ */
function getThumb(url) {
  return url ? url : "https://via.placeholder.com/55?text=IMG";
}

/* ============================
   INVENTORY LIVE LISTENER
============================ */
function startInventoryListener() {
  if (!inventoryUnsub) {}

  inventoryUnsub = db.collection("shops")
    .doc(shopId)
    .collection("items")
    .orderBy("name")
    .onSnapshot(snapshot => {
      let html = "";
      let categories = new Set();
      let lowStock = 0;
      let active = 0;

      snapshot.forEach(doc => {
        const x = doc.data();
        if (x.category) categories.add(x.category);
        if (x.stock < (x.minStock || 5)) lowStock++;
        if (x.status !== "inactive") active++;

        html += `
          <tr class="${x.stock < (x.minStock || 5) ? "low-stock" : ""}">
            <td><img src="${getThumb(x.imageUrl)}" class="thumb-img" /></td>
            <td>${x.name}</td>
            <td>‚Çπ${x.price}</td>
            <td>${x.discountPercent || 0}%</td>
            <td>‚Çπ${x.offerPrice || x.price}</td>
            <td>${x.stock}</td>
            <td>${x.unit}</td>
            <td>${x.category}</td>
            <td class="nowrap">
              <button class="btn btn-sm btn-warning me-1" onclick="editItem('${doc.id}')">‚úèÔ∏è</button>
              <button class="btn btn-sm btn-danger" onclick="deleteItem('${doc.id}')">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });

      document.getElementById("inventory-table").innerHTML = html;
      document.getElementById("stat-items").textContent = snapshot.size;
      document.getElementById("stat-cat").textContent = categories.size;
      document.getElementById("stat-low").textContent = lowStock;
      document.getElementById("stat-active").textContent = active;

      setStatus("Inventory Loaded", "success");
    });
}

/* ============================
   OPEN ITEM MODAL
============================ */
function openModal() {
  document.getElementById("modal-title").innerText = "‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ";

  document.getElementById("item-id").value = "";
  document.getElementById("item-name").value = "";
  document.getElementById("item-price").value = "";
  document.getElementById("item-discount").value = "";
  document.getElementById("item-offerprice").value = "";
  document.getElementById("item-stock").value = "";
  document.getElementById("item-min-stock").value = "";
  document.getElementById("item-unit").value = "";
  document.getElementById("item-category").value = "";
  document.getElementById("item-description").value = "";
  document.getElementById("item-active").checked = true;

  const prev = document.getElementById("photo-preview");
  prev.style.display = "none";
  prev.src = "";

  document.getElementById("item-photo").value = "";

  new bootstrap.Modal(document.getElementById("itemModal")).show();
}

/* ============================
   EDIT ITEM
============================ */
async function editItem(id) {
  const snap = await db.collection("shops").doc(shopId).collection("items").doc(id).get();
  if (!snap.exists) return;

  const x = snap.data();
  document.getElementById("modal-title").innerText = "‡§Ü‡§á‡§ü‡§Æ ‡§∏‡§Ç‡§™‡§æ‡§¶‡§®";

  document.getElementById("item-id").value = id;
  document.getElementById("item-name").value = x.name;
  document.getElementById("item-price").value = x.price;
  document.getElementById("item-discount").value = x.discountPercent || 0;
  document.getElementById("item-offerprice").value = x.offerPrice || "";
  document.getElementById("item-stock").value = x.stock;
  document.getElementById("item-min-stock").value = x.minStock || 5;
  document.getElementById("item-unit").value = x.unit;
  document.getElementById("item-category").value = x.category;
  document.getElementById("item-description").value = x.description || "";
  document.getElementById("item-active").checked = x.status !== "inactive";

  const prev = document.getElementById("photo-preview");
  if (x.imageUrl) {
    prev.src = x.imageUrl;
    prev.style.display = "block";
  } else {
    prev.style.display = "none";
  }

  new bootstrap.Modal(document.getElementById("itemModal")).show();
}

/* ============================
   CLOUDINARY UPLOAD
============================ */
async function uploadToCloudinary(file) {
  if (!file) return null;

  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

  const res = await fetch(CLOUDINARY_URL, {
    method: "POST",
    body: fd
  });

  const data = await res.json();
  return data.secure_url || data.url || null;
}

/* ============================
   SAVE ITEM
============================ */
async function saveItem() {
  const id = document.getElementById("item-id").value;
  const name = document.getElementById("item-name").value.trim();
  const price = Number(document.getElementById("item-price").value);
  const discount = Number(document.getElementById("item-discount").value);
  const offer = Number(document.getElementById("item-offerprice").value);
  const stock = Number(document.getElementById("item-stock").value);
  const minStock = Number(document.getElementById("item-min-stock").value);
  const unit = document.getElementById("item-unit").value.trim();
  const category = document.getElementById("item-category").value.trim();
  const desc = document.getElementById("item-description").value.trim();
  const active = document.getElementById("item-active").checked;
  const file = document.getElementById("item-photo").files[0];

  if (!name) return alert("‡§®‡§æ‡§Æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à");

  setStatus("Saving item...");

  let imageUrl = null;
  if (file) imageUrl = await uploadToCloudinary(file);

  const ref = db.collection("shops").doc(shopId).collection("items");
  const data = {
    name,
    price,
    discountPercent: discount || 0,
    offerPrice: offer || price,
    stock,
    minStock: minStock || 5,
    unit,
    category,
    description: desc,
    status: active ? "active" : "inactive",
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  if (imageUrl) data.imageUrl = imageUrl;

  if (id) await ref.doc(id).update(data); 
  else await ref.add({ ...data, createdAt: firebase.firestore.FieldValue.serverTimestamp() });

  setStatus("Saved!", "success");
  bootstrap.Modal.getInstance(document.getElementById("itemModal")).hide();
}

/* ============================
   DELETE ITEM
============================ */
function deleteItem(id) {
  if (!confirm("‡§Ü‡§á‡§ü‡§Æ ‡§π‡§ü‡§æ‡§è‡§Ç?")) return;
  db.collection("shops").doc(shopId).collection("items").doc(id).delete();
}
    /* ============================
   ORDERS: listener, UI, status updates
============================ */
document.getElementById('btn-open-orders').addEventListener('click', ()=> {
  new bootstrap.Modal(document.getElementById('ordersModal')).show();
});

function startOrdersListener(){
  if(ordersUnsub) ordersUnsub();
  ordersUnsub = db.collection('shops').doc(shopId).collection('orders').orderBy('createdAt','desc')
    .onSnapshot(snap=>{
      const tbody = document.getElementById('orders-table');
      tbody.innerHTML = '';
      let count = 0;
      snap.forEach(doc=>{
        const o = doc.data(); const id = doc.id;
        const itemsText = (o.items || []).map(it=>`${it.name} x${it.qty}`).join('<br>') || (o.itemsText||'‚Äî');
        const payment = o.paymentMethod || o.paymentType || 'COD';
        const status = o.status || 'new';
        const time = o.createdAt && o.createdAt.toDate ? o.createdAt.toDate().toLocaleString() : (o.createdAt||'');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="nowrap">${id}</td>
          <td class="text-start">${o.customerName||o.phone||'‚Äî'}</td>
          <td class="text-start">${itemsText}</td>
          <td class="nowrap">‚Çπ${o.amount||o.total||0}</td>
          <td>${payment}${o.txnId?('<br/><small>Txn: '+o.txnId+'</small>'):''}</td>
          <td><span class="badge ${status==='delivered'?'bg-success':status==='ready'?'bg-info':status==='packed'?'bg-warning':'bg-secondary'}">${status}</span></td>
          <td class="nowrap">${time}</td>
          <td><button class="btn btn-sm btn-outline-primary" onclick="openOrderDetail('${id}')">‡§¶‡•á‡§ñ‡•á‡§Ç</button></td>
        `;
        tbody.appendChild(tr);
        count++;
      });
      document.getElementById('orders-status').innerText = `Total orders: ${count}`;
      setStatus('Orders loaded','success');
    }, err => { console.error('orders listener', err); setStatus('Error loading orders: '+err.message,'danger'); });
}

async function openOrderDetail(orderId){
  try{
    const ref = db.collection('shops').doc(shopId).collection('orders').doc(orderId);
    const snap = await ref.get();
    if(!snap.exists){ alert('Order missing'); return; }
    const o = snap.data();
    const content = document.getElementById('order-detail-content');
    const itemsHtml = (o.items || []).map(it=>`<div>${it.name} <small> x${it.qty}</small> ‚Çπ${it.price||''}</div>`).join('') || (o.itemsText||'‚Äî');
    content.innerHTML = `
      <div><strong>Order:</strong> ${orderId}</div>
      <div><strong>Customer:</strong> ${o.customerName||o.phone||'‚Äî'}</div>
      <div class="mt-2"><strong>Items:</strong><div>${itemsHtml}</div></div>
      <div class="mt-2"><strong>Amount:</strong> ‚Çπ${o.amount||o.total||0}</div>
      <div class="mt-2"><strong>Payment:</strong> ${o.paymentMethod||o.paymentType||'COD'}</div>
      <div class="mt-2"><strong>Notes:</strong> ${o.notes||'‚Äî'}</div>
    `;
    document.getElementById('order-utr').value = o.txnId || o.utr || '';
    const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
    modal.show();

    ['btn-accept','btn-packed','btn-ready','btn-delivered'].forEach(id=>{
      const old = document.getElementById(id);
      if(!old) return;
      const clone = old.cloneNode(true);
      old.parentNode.replaceChild(clone, old);
    });

    const handler = status => async () => {
      const utr = document.getElementById('order-utr').value.trim() || null;
      await updateOrderStatus(orderId, status, utr);
      modal.hide();
    };

    document.getElementById('btn-accept').addEventListener('click', handler('accepted'));
    document.getElementById('btn-packed').addEventListener('click', handler('packed'));
    document.getElementById('btn-ready').addEventListener('click', handler('ready'));
    document.getElementById('btn-delivered').addEventListener('click', handler('delivered'));

  }catch(e){ console.error(e); alert('Error: '+e.message); }
}

async function updateOrderStatus(orderId, status, txnId=null){
  const ref = db.collection('shops').doc(shopId).collection('orders').doc(orderId);
  const payload = {
    status,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    history: firebase.firestore.FieldValue.arrayUnion({ status, ts: firebase.firestore.FieldValue.serverTimestamp() })
  };
  if(txnId) payload.txnId = txnId;
  await ref.update(payload);
  db.collection('shops').doc(shopId).collection('notifications').add({
    type:'order-status', orderId, status, createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).catch(()=>{});
}

/* ============================
   AUTH + STARTUP
============================ */
auth.onAuthStateChanged(async user=>{
  if(!user){
    try{ window.location.href = 'index.html'; }catch(e){}
    return;
  }
  // resolve shopId from localStorage or shopUsers doc
  try{
    const ls = localStorage.getItem('shopId');
    if(ls) shopId = ls;
    else {
      const su = await db.collection('shopUsers').doc(user.uid).get();
      if(su.exists && su.data().shopId) shopId = su.data().shopId;
      else { shopId = 'SHOP001'; localStorage.setItem('shopId', shopId); }
    }
  }catch(e){ shopId = 'SHOP001'; }
  setStatus('Shop ID: '+shopId,'secondary');
  startInventoryListener();
  startOrdersListener();
});

/* ============================
   LOGOUT & CLEANUP
============================ */
function logout(){ auth.signOut().finally(()=>{ try{ localStorage.removeItem('shopId'); }catch(e){} window.location.href='index.html'; }); }

window.addEventListener('beforeunload', ()=> {
  try{ if(inventoryUnsub) inventoryUnsub(); if(ordersUnsub) ordersUnsub(); }catch(e){}
});

/* ============================
   END OF SCRIPT
============================ */
</script>
</body>
</html>
````Ó®Å0Ó®Ç
    
