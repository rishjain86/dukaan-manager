<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Dukaan Manager - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f7fa;
    }
    .navbar-brand {
      font-weight: 600;
      font-size: 20px;
    }
    .low-stock {
      background: #fff3cd !important;
    }
    .table thead {
      background: #0d6efd;
      color: white;
    }
    .thumb-img {
      width: 46px;
      height: 46px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
    }
    .status-small {
      font-size: 12px;
    }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand">Dukaan Manager</span>
    <button class="btn btn-light btn-sm" onclick="logout()">Logout</button>
  </div>
</nav>

<div class="container mt-4">

  <h4>üì¶ ‡§á‡§®‡•ç‡§µ‡•á‡§Ç‡§ü‡§∞‡•Ä</h4>

  <!-- Add Item Button -->
  <button class="btn btn-success btn-sm mb-3" onclick="openModal()">+ ‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>

  <!-- Inventory Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover text-center align-middle">
      <thead>
      <tr>
        <th>‡§´‡•ã‡§ü‡•ã</th>
        <th>‡§®‡§æ‡§Æ</th>
        <th>‡§ï‡•Ä‡§Æ‡§§</th>
        <th>‡§∏‡•ç‡§ü‡•â‡§ï</th>
        <th>‡§á‡§ï‡§æ‡§à</th>
        <th>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</th>
        <th>‡§ï‡§æ‡§∞‡•ç‡§Ø</th>
      </tr>
      </thead>
      <tbody id="inventory-table"></tbody>
    </table>
  </div>

  <div id="status" class="small text-muted mt-1"></div>
</div>

<!-- ADD/EDIT Modal -->
<div class="modal fade" id="itemModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modal-title">‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="item-id"/>

        <label class="form-label">‡§®‡§æ‡§Æ</label>
        <input id="item-name" class="form-control mb-2" required>

        <label class="form-label">‡§ï‡•Ä‡§Æ‡§§ (‚Çπ)</label>
        <input id="item-price" type="number" class="form-control mb-2">
        <label class="form-label">‡§°‡§ø‡§∏‡•ç‡§ï‡§æ‡§â‡§Ç‡§ü (%)</label>
<input id="item-discount" type="number" class="form-control mb-2" placeholder="0">

<label class="form-label">‡§ë‡§´‡§∞ ‡§™‡•ç‡§∞‡§æ‡§á‡§∏ (‚Çπ)</label>
<input id="item-offerprice" type="number" class="form-control mb-2" placeholder="0">
        <label class="form-label">‡§∏‡•ç‡§ü‡•â‡§ï</label>
        <input id="item-stock" type="number" class="form-control mb-2">

        <label class="form-label">‡§á‡§ï‡§æ‡§à</label>
        <input id="item-unit" class="form-control mb-2" placeholder="kg / packet / liter">

        <label class="form-label">‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</label>
        <input id="item-category" class="form-control mb-2" placeholder="Dairy, Snacks, ‡§Ü‡§¶‡§ø">

        <small class="text-muted status-small">
          ‡§´‡•ã‡§ü‡•ã upload ‡§Ö‡§≠‡•Ä disabled ‡§π‡•à, category ‡§ï‡•á ‡§π‡§ø‡§∏‡§æ‡§¨ ‡§∏‡•á icon ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ‡•§
        </small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">‡§∞‡§¶‡•ç‡§¶</button>
        <button class="btn btn-primary" onclick="saveItem()">‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase v9 COMPAT (same as index.html, WITHOUT storage) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  /************* Firebase Config - SAME as index.html *************/
  const firebaseConfig = {
    apiKey: "AIzaSyAomDsqeLOrXvnudqUsudnZWOphuqM0bvY",
    authDomain: "shopkeeper-99756.firebaseapp.com",
    projectId: "shopkeeper-99756",
    storageBucket: "shopkeeper-99756.firebasestorage.app",
    messagingSenderId: "786338847396",
    appId: "1:786338847396:web:c6e042952145780f8aa431",
    measurementId: "G-PCE1MM86YE"
  };

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  const auth = firebase.auth();
  const db   = firebase.firestore();
// ===== Category ‚Üí Icon map (PNG from Icons8) =====
const CATEGORY_ICONS = {
  fruits: "https://img.icons8.com/color/48/apple.png",
  bakery: "https://img.icons8.com/color/48/bread.png",
  dairy: "https://img.icons8.com/color/48/milk-bottle.png",
  snacks: "https://img.icons8.com/color/48/chips.png",
  beverages: "https://img.icons8.com/color/48/soda-can.png",
  spices: "https://img.icons8.com/color/48/spice.png",
  "household & personal care": "https://img.icons8.com/color/48/cleaning-a-surface.png",
  "grains & pulses": "https://img.icons8.com/color/48/wheat.png",
  default: "https://img.icons8.com/color/48/shop.png"
};

function getCategoryIcon(category) {
  if (!category) return CATEGORY_ICONS.default;
  const c = category.toLowerCase();

  if (c.includes("fruit")) return CATEGORY_ICONS.fruits;
  if (c.includes("bakery")) return CATEGORY_ICONS.bakery;
  if (c.includes("dairy") || c.includes("milk")) return CATEGORY_ICONS.dairy;
  if (c.includes("snack")) return CATEGORY_ICONS.snacks;
  if (c.includes("beverage") || c.includes("drink")) return CATEGORY_ICONS.beverages;
  if (c.includes("spice") || c.includes("masala")) return CATEGORY_ICONS.spices;
  if (c.includes("household") || c.includes("personal")) return CATEGORY_ICONS["household & personal care"];
  if (c.includes("grain") || c.includes("pulse") || c.includes("dal")) return CATEGORY_ICONS["grains & pulses"];

  return CATEGORY_ICONS.default;
}

  let shopId = null;
  let inventoryUnsub = null;

  function setStatus(msg, type = "muted") {
    const el = document.getElementById('status');
    el.textContent = msg || "";
    el.className = "small mt-1 text-" + type;
  }

  /************* Helper: Category-based icon *************/
  function getCategoryIcon(category) {
    const base = "https://via.placeholder.com/60?text=";
    const c = (category || "").toLowerCase();

    if (c.includes("dairy") || c.includes("milk") || c.includes("‡§¶‡•Ç‡§ß") || c.includes("‡§°‡•á‡§Ø‡§∞‡•Ä")) {
      return base + encodeURIComponent("Dairy");
    }
    if (c.includes("snack") || c.includes("namkeen") || c.includes("‡§∏‡•ç‡§®‡•à‡§ï") || c.includes("‡§®‡§Æ‡§ï‡•Ä‡§®")) {
      return base + encodeURIComponent("Snacks");
    }
    if (c.includes("atta") || c.includes("aata") || c.includes("flour") || c.includes("‡§Ü‡§ü‡§æ") || c.includes("‡§Ö‡§®‡§æ‡§ú")) {
      return base + encodeURIComponent("Grain");
    }
    if (c.includes("masala") || c.includes("spice") || c.includes("‡§Æ‡§∏‡§æ‡§≤‡§æ")) {
      return base + encodeURIComponent("Masala");
    }
    if (c.includes("biscuit") || c.includes("cookies") || c.includes("‡§¨‡§ø‡§∏‡•ç‡§ï‡§ø‡§ü")) {
      return base + encodeURIComponent("Biscuit");
    }
    if (c.includes("oil") || c.includes("‡§§‡•á‡§≤")) {
      return base + encodeURIComponent("Oil");
    }
    if (c.includes("personal") || c.includes("soap") || c.includes("tooth") || c.includes("‡§∏‡§æ‡§¨‡•Å‡§®")) {
      return base + encodeURIComponent("Care");
    }
    if (c.includes("cold") || c.includes("soft") || c.includes("drink") || c.includes("‡§™‡•á‡§Ø") || c.includes("juice")) {
      return base + encodeURIComponent("Drinks");
    }
    if (c.includes("vegetable") || c.includes("‡§∏‡§¨‡•ç‡§ú") || c.includes("‡§≠‡§æ‡§ú‡•Ä")) {
      return base + encodeURIComponent("Veg");
    }
    if (c.includes("fruit") || c.includes("‡§´‡§≤")) {
      return base + encodeURIComponent("Fruit");
    }

    return base + encodeURIComponent("Item");
  }

  /************* LOAD INVENTORY (after auth + shopId ready) *************/
  function startInventoryListener() {
    if (!shopId) {
      setStatus("No shopId set.", "danger");
      return;
    }

    if (inventoryUnsub) {
      inventoryUnsub();
    }

    setStatus("Loading inventory...", "secondary");

    inventoryUnsub = db
      .collection("shops")
      .doc(shopId)
      .collection("items")
      .orderBy("name")
      .onSnapshot(
        (snapshot) => {
          let html = "";
          snapshot.forEach(doc => {
            const item = doc.data();
            const hasMin = typeof item.minStock === "number";
            const low  = (hasMin && item.stock <= item.minStock) ? "low-stock" : "";
            const photo = getCategoryIcon(item.category);

            html += `
              <tr class="${low}">
                <td><img src="${photo}" class="thumb-img" alt="photo"></td>
                <td>${item.name || ""}</td>
                <td>‚Çπ${item.price ?? ""}</td>
                <td>${item.stock ?? ""}</td>
                <td>${item.unit || ""}</td>
                <td>${item.category || ""}</td>
                <td>
                  <button class="btn btn-sm btn-warning" onclick="editItem('${doc.id}')">‚úè</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteItem('${doc.id}')">üóë</button>
                </td>
              </tr>`;
          });
          document.getElementById("inventory-table").innerHTML = html;
          setStatus("Inventory loaded (" + snapshot.size + " items).", "success");
        },
        (err) => {
          console.error("Inventory listener error:", err);
          setStatus("Error loading inventory: " + err.message, "danger");
        }
      );
  }

  /************* AUTH + SHOP RESOLVE *************/
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      alert("Session expired. Please login again.");
      window.location.href = "index.html";
      return;
    }

    try {
      // 1) Try localStorage (index.html ne yahan save kiya tha)
      shopId = null;
      try {
        shopId = localStorage.getItem("shopId");
      } catch (e) {
        console.warn("Cannot read shopId from localStorage:", e);
      }

      // 2) Backup: shopUsers collection se nikaal lo
      if (!shopId) {
        const doc = await db.collection("shopUsers").doc(user.uid).get();
        if (doc.exists) {
          shopId = doc.data().shopId;
        }
      }

      if (!shopId) {
        alert("No shop linked with this user. Please register again.");
        window.location.href = "index.html";
        return;
      }

      setStatus("Shop ID: " + shopId, "secondary");
      startInventoryListener();
    } catch (e) {
      console.error(e);
      setStatus("Error resolving shop: " + e.message, "danger");
    }
  });

  /************* Add/Edit Item Modal helpers *************/
  function openModal() {
    document.getElementById("modal-title").textContent = "‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ";
    document.getElementById("item-id").value = "";
    document.getElementById("item-name").value = "";
    document.getElementById("item-price").value = "";
    document.getElementById("item-stock").value = "";
    document.getElementById("item-unit").value = "";
    document.getElementById("item-category").value = "";

    new bootstrap.Modal(document.getElementById("itemModal")).show();
  }

  function editItem(id) {
    if (!shopId) return;
    db.collection("shops").doc(shopId).collection("items").doc(id).get()
      .then(doc => {
        if (!doc.exists) return;
        const i = doc.data();
        document.getElementById("modal-title").textContent = "‡§Ü‡§á‡§ü‡§Æ ‡§∏‡§Ç‡§™‡§æ‡§¶‡§®";
        document.getElementById("item-id").value = id;
        document.getElementById("item-name").value = i.name || "";
        document.getElementById("item-price").value = i.price ?? "";
        document.getElementById("item-stock").value = i.stock ?? "";
        document.getElementById("item-unit").value = i.unit || "";
        document.getElementById("item-category").value = i.category || "";

        new bootstrap.Modal(document.getElementById("itemModal")).show();
      })
      .catch(err => {
        console.error(err);
        setStatus("Error loading item: " + err.message, "danger");
      });
  }

  /************* Save Item (add/update, NO photo upload) *************/
  async function saveItem() {
    if (!shopId) return;

    const id   = document.getElementById("item-id").value;
    const name = document.getElementById("item-name").value.trim();
    const price = Number(document.getElementById("item-price").value || 0);
    const stock = Number(document.getElementById("item-stock").value || 0);
    const unit  = document.getElementById("item-unit").value.trim();
    const category = document.getElementById("item-category").value.trim();

    if (!name) {
      alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§≠‡§∞‡•á‡§Ç");
      return;
    }

    const colRef = db.collection("shops").doc(shopId).collection("items");
    let docRef;

    if (id) {
      docRef = colRef.doc(id);
    } else {
      docRef = colRef.doc(); // new id
    }

    try {
      setStatus("Saving item...", "secondary");

      const itemData = {
        name,
        price,
        stock,
        unit,
        category,
        minStock: 5,
        status: "active"
      };

      if (id) {
        await docRef.update(itemData);
      } else {
        await docRef.set(itemData);
      }

      setStatus("Item saved.", "success");
      bootstrap.Modal.getInstance(document.getElementById("itemModal")).hide();
    } catch (err) {
      console.error(err);
      setStatus("Error saving item: " + err.message, "danger");
    }
  }

  /************* Delete *************/
  function deleteItem(id) {
    if (!shopId) return;
    if (!confirm("‡§Ü‡§á‡§ü‡§Æ ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;

    db.collection("shops").doc(shopId).collection("items").doc(id).delete()
      .then(() => {
        setStatus("Item deleted.", "success");
      })
      .catch(err => {
        console.error(err);
        setStatus("Error deleting item: " + err.message, "danger");
      });
  }

  /************* Logout *************/
  function logout() {
    auth.signOut().finally(() => {
      try { localStorage.removeItem("shopId"); } catch (e) {}
      window.location.href = "index.html";
    });
  }
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>


